!function(t){"use strict";var i=1,h=2,s=4,e=8,a=16,o=32,r={stroke:!0,color:"white",weight:2,opacity:1,fill:!0,fillColor:"white",fillOpacity:.1,clickable:!0};t.PrintRectangle=t.Class.extend({includes:t.Mixin.Events,options:{ratio:1.5,allowRotate:!0,markerDim:20},initialize:function(i){t.setOptions(this,i),this.initSizeRatio=.9,this.minimumDim=3.6*this.options.markerDim,this.whRatio=this.options.ratio},addTo:function(n){this.map=n,this.rectangle=new t.Rectangle(n.getBounds(),r);var g,d,p,l=[i,h,s],m=["left","center","right"],c=[e,a,o],x=["top","middle","bottom"],u={icon:null,clickable:!0,draggable:!0,keyboard:!0},f={iconSize:[this.options.markerDim,this.options.markerDim],iconAnchor:[0,0],className:""};this.resizeMarkers=[],this.featureGroup=t.featureGroup();for(var L=0;L<l.length;L++)for(var M=0;M<c.length;M++){var _=l[L]+c[M];_&i&&(g=0+r.weight),_&h&&(g=this.options.markerDim/2),_&s&&(g=this.options.markerDim-r.weight),_&e&&(d=0+r.weight),_&a&&(d=this.options.markerDim/2),_&o&&(d=this.options.markerDim-r.weight),f.iconAnchor=[g,d],f.className="lpr-marker "+m[L]+" "+x[M],u.icon=t.divIcon(f),p=t.marker([0,0],u),p.type=_,p.on("dragstart",this._marker_onDragStart,this),p.on("drag",this._marker_onDrag,this),p.on("dragend",this._marker_onDragEnd,this),this.resizeMarkers[_]=p,this.featureGroup.addLayer(p)}this.centerMarker=this.resizeMarkers[h+a],this.fixedMarker=this.centerMarker,this.rectangle.addTo(this.map),this.rectangle.bringToFront(),this.featureGroup.addTo(this.map),this._container=t.DomUtil.create("div","lpr-container",this.map._controlContainer),this._topShade=t.DomUtil.create("div","lpr-shade",this._container),this._bottomShade=t.DomUtil.create("div","lpr-shade",this._container),this._leftShade=t.DomUtil.create("div","lpr-shade",this._container),this._rightShade=t.DomUtil.create("div","lpr-shade",this._container),t.DomEvent.addListener(this._container,"contextmenu",t.DomEvent.stop);var k=this.map.getPixelBounds();return this.pixelWidth=this.initSizeRatio*k.getSize().x,this.pixelHeight=this.initSizeRatio*k.getSize().y,this.pixelWidth>this.pixelHeight*this.whRatio?this.pixelWidth=this.pixelHeight*this.whRatio:this.pixelHeight=this.pixelWidth/this.whRatio,this.center=(k.max.x-k.min.x)/2,this.middle=(k.max.y-k.min.y)/2,this._update(),this.setRatio(this.whRatio),this.options.allowRotate&&this.rectangle.on("click",this.rotate,this),this.map.on("drag",this._onMapChange,this),this.map.on("zoomend",this._onMapZoom,this),this.map.on("moveend",this._onMapChange,this),this.map.on("resize",this._onMapChange,this),this},_update:function(){function r(t,i){t.style.display=i.width>0&&i.height>0?"block":"none",t.style.width=i.width+"px",t.style.height=i.height+"px",t.style.top=i.top+"px",t.style.left=i.left+"px",t.style.bottom=i.bottom+"px",t.style.right=i.right+"px"}var n=this.fixedMarker.type,g=this.pixelHeight/2,d=this.pixelWidth/2;n&a&&(this.top=this.middle-g,this.bottom=this.middle+g),n&h&&(this.left=this.center-d,this.right=this.center+d),n&e&&(this.bottom=this.top+this.pixelHeight),n&o&&(this.top=this.bottom-this.pixelHeight),n&i&&(this.right=this.left+this.pixelWidth),n&s&&(this.left=this.right-this.pixelWidth),this.center=this.left+(this.right-this.left)/2,this.middle=this.top+(this.bottom-this.top)/2;var p=t.latLngBounds(this.map.containerPointToLatLng([this.left,this.bottom]),this.map.containerPointToLatLng([this.right,this.top]));this.rectangle.setBounds(p),this.resizeMarkers[i+e].setLatLng(p.getNorthWest()),this.resizeMarkers[i+o].setLatLng(p.getSouthWest()),this.resizeMarkers[s+e].setLatLng(p.getNorthEast()),this.resizeMarkers[s+o].setLatLng(p.getSouthEast()),this.resizeMarkers[i+a].setLatLng(this.map.containerPointToLatLng([this.left,this.middle])),this.resizeMarkers[s+a].setLatLng(this.map.containerPointToLatLng([this.right,this.middle])),this.resizeMarkers[h+e].setLatLng(this.map.containerPointToLatLng([this.center,this.top])),this.resizeMarkers[h+o].setLatLng(this.map.containerPointToLatLng([this.center,this.bottom])),this.resizeMarkers[h+a].setLatLng(this.map.containerPointToLatLng([this.center,this.middle]));var l=this.map.getSize();r(this._topShade,{width:l.x,height:this.top,top:0,left:0}),r(this._bottomShade,{width:l.x,height:l.y-this.bottom,bottom:0,left:0}),r(this._leftShade,{width:this.left,height:this.pixelHeight,top:this.top,left:0}),r(this._rightShade,{width:l.x-this.right,height:this.pixelHeight,top:this.top,right:0})},_calcPointBounds:function(){var t=this.map.latLngToContainerPoint(this.rectangle.getBounds().getNorthWest()),i=this.map.latLngToContainerPoint(this.rectangle.getBounds().getSouthEast());this.left=t.x,this.top=t.y,this.right=i.x,this.bottom=i.y,this.center=this.left+(this.right-this.left)/2,this.middle=this.top+(this.bottom-this.top)/2,this.pixelWidth=this.right-this.left,this.pixelHeight=this.bottom-this.top},_calcDrawPointBounds:function(){this.maxBounds=this.map.options.maxBounds?this.map.options.maxBounds:t.latLngBounds([-90,180],[90,-180]);var i=this.map.latLngToContainerPoint(this.maxBounds.getNorthWest()),h=this.map.latLngToContainerPoint(this.maxBounds.getSouthEast());this.dragLeft=i.x,this.dragTop=i.y,this.dragRight=h.x,this.dragBottom=h.y,this.dragWidth=this.dragRight-this.dragLeft,this.dragHeight=this.dragBottom-this.dragTop},_onMapChange:function(){this._calcPointBounds(),this._update()},_onMapZoom:function(){this.setRatio(this.whRatio)},_marker_onDragStart:function(r){this.dragMarker=r.target,this.isMoving=this.dragMarker==this.centerMarker,this._calcPointBounds(),this._calcDrawPointBounds();var n,g,d,p,l=this.pixelHeight/2,m=this.pixelWidth/2;this.isMoving?(this.dragLeft+=m,this.dragTop+=l,this.dragRight-=m,this.dragBottom-=l):(n=this.dragMarker.type,g=(n&h+a)+(n&e?o:0)+(n&o?e:0)+(n&i?s:0)+(n&s?i:0),this.fixedMarker=this.resizeMarkers[g],n=r.target.type,n&e&&(d=this.pixelHeight+this.top-this.dragTop),n&o&&(d=this.pixelHeight+this.dragBottom-this.bottom),n&a&&(d=this.pixelHeight+2*Math.min(this.top-this.dragTop,this.dragBottom-this.bottom)),n&i&&(p=this.pixelWidth+this.left-this.dragLeft),n&s&&(p=this.pixelWidth+this.dragRight-this.right),n&h&&(p=this.pixelWidth+2*Math.min(this.left-this.dragLeft,this.dragRight-this.right)),p>d*this.whRatio?p=d*this.whRatio:d=p/this.whRatio,n&e&&(this.dragBottom=this.bottom-this.minHeight,this.dragTop=this.bottom-d),n&o&&(this.dragTop=this.top+this.minHeight,this.dragBottom=this.top+d),n&i&&(this.dragLeft=this.right-p,this.dragRight=this.right-this.minWidth),n&s&&(this.dragLeft=this.left+this.minWidth,this.dragRight=this.left+p),n&h&&(this.dragLeft=this.center,this.dragRight=this.center),n&a&&(this.dragTop=this.middle,this.dragBottom=this.middle)),this.dragBounds=t.latLngBounds(this.map.containerPointToLatLng([this.dragLeft,this.dragBottom]),this.map.containerPointToLatLng([this.dragRight,this.dragTop]))},_marker_onDrag:function(t){var i=t.target.getLatLng();if(this.dragBounds.contains(i)||(i.lat=Math.max(Math.min(i.lat,this.dragBounds.getNorth()),this.dragBounds.getSouth()),i.lng=Math.max(Math.min(i.lng,this.dragBounds.getEast()),this.dragBounds.getWest())),this.isMoving){var h=this.map.latLngToContainerPoint(i);this.center=h.x,this.middle=h.y}else{var s=this.map.latLngToContainerPoint(this.fixedMarker.getLatLng()),e=this.map.latLngToContainerPoint(i);this.pixelWidth=Math.abs(s.x-e.x),this.pixelHeight=Math.abs(s.y-e.y),this.pixelWidth=Math.max(this.pixelWidth,this.pixelHeight*this.whRatio),this.pixelHeight=Math.max(this.pixelHeight,this.pixelWidth/this.whRatio)}this._update()},_marker_onDragEnd:function(){this.dragMarker=null,this.fixedMarker=this.centerMarker,this.isMoving=!1},setRatio:function(t){this.whRatio=t,this._calcPointBounds(),this.whRatio>1?(this.minHeight=this.minimumDim,this.minWidth=this.minHeight*this.whRatio):(this.minWidth=this.minimumDim,this.minHeight=this.minWidth/this.whRatio);var i=Math.max(this.pixelWidth,this.pixelHeight);this.whRatio<1?(this.pixelHeight=i,this.pixelWidth=this.pixelHeight*this.whRatio):(this.pixelWidth=i,this.pixelHeight=this.pixelWidth/this.whRatio),this._calcDrawPointBounds(),this.pixelHeight=Math.max(this.minHeight,Math.min(this.pixelHeight,this.dragHeight)),this.pixelWidth=Math.max(this.minWidth,Math.min(this.pixelWidth,this.dragWidth)),this.pixelWidth>this.pixelHeight*this.whRatio?this.pixelWidth=this.pixelHeight*this.whRatio:this.pixelHeight=this.pixelWidth/this.whRatio,this._update(),this.maxBounds.contains(this.rectangle.getBounds())||(this.middle=this.middle+Math.max(0,this.dragTop-this.top)-Math.max(0,this.bottom-this.dragBottom),this.center=this.center+Math.max(0,this.dragLeft-this.left)-Math.max(0,this.right-this.dragRight),this._update())},rotate:function(){this.setRatio(1/this.whRatio)},remove:function(){this.map.off("zoomend",this._onMapZoom),this.map.off("moveend",this._onMapChange),this.map.off("resize",this._onMapChange),this.map.off("drag",this._onMapChange),this.map.removeLayer(this.featureGroup),this.map.removeLayer(this.rectangle),this._container.remove()}}),t.printRectangle=function(i){return new t.PrintRectangle(i)}}(L,this,document);